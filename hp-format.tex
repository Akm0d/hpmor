% This file includes all the generic formatting for HPatMoR. This mostly entails configuring
% the memoir package, though “configuring” on occasion means “completely messing it up”.

\RequirePackage{fmtcount}
\RequirePackage{calc}

%
% Set-up page sizes
%
\stockmsmallroyalvo
\settrimmedsize{\stockheight}{\stockwidth}{*}
\settypeblocksize{\topskip  + 34\baselineskip}{352pt}{*}
\setlrmargins{*}{*}{1.5}
\setulmargins{*}{*}{1}
\setheadfoot{\topskip +  \baselineskip}{2\baselineskip}
\checkandfixthelayout[fixed]

\fixdvipslayout % fix for xelatex

%
% Fonts used generally (specific fonts used only once or twice are not here).
%
\usepackage{xltxtra}
\setmainfont[
  Numbers=OldStyle
, Ligatures={Common,TeX}
, Extension=.otf
, UprightFont=*-Regular
, ItalicFont=*-Italic
, BoldFont=*-Bold
, BoldItalicFont=*-BoldItalic
, SmallCapsFont=AlegreyaSC-Regular
, SmallCapsFeatures={Letters=SmallCaps}
]{Alegreya}

\newfontface\hp[ExternalLocation, Ligatures={Common,TeX}]{Lumos}

\newfontface\ptsansi[ExternalLocation, Ligatures={Common,TeX}]{AlegreyaSans-Italic}

\newcommand\parsel[1]{{\ptsansi #1}}

%
% Page numbering/footer
%
\def\pageInFooter{\Star\ \hp\makebox[4em][c]{\textls[30]{\thepage}}\Star}
\makeevenfoot{plain}{}{\pageInFooter}{}
\makeoddfoot{plain}{}{\pageInFooter}{}
\makeevenfoot{headings}{}{\pageInFooter}{}
\makeoddfoot{headings}{}{\pageInFooter}{}


%
% Custom chapter style
%
\makeatletter 
\makechapterstyle{evans}{%
	\renewcommand*{\chapnamefont}{\hp\large}
	\renewcommand*{\chapnumfont}{\chapnamefont}
	\renewcommand*{\chaptitlefont}{\hp\huge}
	
	\setlength{\beforechapskip}{4\baselineskip plus 2\baselineskip minus 2\baselineskip }
	\setlength{\midchapskip}{0pt}
	\setlength{\afterchapskip}{1\baselineskip}
	
	\renewcommand*{\printchapternum}{%
		\chapnumfont \hyperref[contents]{\textls[30]{
\IfInteger{\thechapter}{\NUMBERstring{chapter}}{\thechapter}
}}}
	
	\renewcommand*{\printchaptername}{%
		\centering \chapnamefont \hyperref[contents]{\MakeUppercase{\textls[30]{\@chapapp}}}
	}
	
	\renewcommand*{\printchaptertitle}[1]{%
		\vskip 0pt\begin{center}\chaptitlefont \textls[50]{\MakeUppercase{##1}}\end{center}\par
	}
	
	\renewcommand*{\chaptermark}[1]{
		\markboth{
                  \MakeUppercase{##1}
                }{
		  \MakeUppercase{\chaptername}~
                    \thechapter
                }
        }

	\renewcommand*{\tocmark}{\markboth{}{\MakeUppercase{Contents}}}
	\renewcommand{\tocheadstart}{\chapterheadstart}
	\renewcommand{\aftertoctitle}{\thispagestyle{empty}\afterchaptertitle}
}
\makeatother
\chapterstyle{evans}

\def\chapterheadstart{\vspace*{-1\baselineskip}\vspace*{-1\topskip}\vspace*{\beforechapskip}}

%
% Subsection
%
\setsubsecheadstyle{\scshape}
\beforesubsecskip=1.5\baselineskip %        skip before the heading
\aftersubsecskip=.5\baselineskip plus .5\baselineskip %         skip after the heading
\setsubsechook{\nopagebreak\vskip 0pt plus 3\baselineskip}

%
% Lettrine font pick
%
\renewcommand{\LettrineFontHook}{\hp}
\renewcommand{\LettrineTextFont}{}

\newcommand\lettrinemph[3][]{\lettrine[#1]{#2}{\emph{#3}}}
\renewcommand{\DefaultLoversize}{.1}
\renewcommand{\DefaultLraise}{0}

%
%
%
\usepackage{graphicx} % for \reflectbox
\makeevenhead{headings}{\Stars}{
	\hp\hyperref[contents]{\textls[50]{\rightmark}}}{\reflectbox{\Stars}}
\makeatletter
\makeoddhead{headings}{\Stars}{\parbox{97mm}{\centering\hp\textls[50]{\leftmark}}}{\reflectbox{\Stars}}

\copypagestyle{cleared}{empty}
\makepsmarks{headings}{%
\createmark{chapter}{right}{shownumber}{\@chapapp\ }{. \ }}
\makeatother


%%%%%%%%%%%%%
\setlength{\emergencystretch}{.06\textwidth}

% Allow linebreaks after em-dash and hyphens, except when they’re followed by punctuation

\newXeTeXintercharclass \punctuationClass

\XeTeXcharclass `\’ \punctuationClass
\XeTeXcharclass `\‘ \punctuationClass
\XeTeXcharclass `\“ \punctuationClass
\XeTeXcharclass `\” \punctuationClass
\XeTeXcharclass `\. \punctuationClass
\XeTeXcharclass `\, \punctuationClass
\XeTeXcharclass `\: \punctuationClass
\XeTeXcharclass `\? \punctuationClass
\XeTeXcharclass `\! \punctuationClass
\XeTeXcharclass `\: \punctuationClass

\newXeTeXintercharclass \digitClass
\XeTeXcharclass `\0 \digitClass
\XeTeXcharclass `\1 \digitClass
\XeTeXcharclass `\2 \digitClass
\XeTeXcharclass `\3 \digitClass
\XeTeXcharclass `\4 \digitClass
\XeTeXcharclass `\5 \digitClass
\XeTeXcharclass `\6 \digitClass
\XeTeXcharclass `\7 \digitClass
\XeTeXcharclass `\8 \digitClass
\XeTeXcharclass `\9 \digitClass

\newXeTeXintercharclass \dashClass
\XeTeXcharclass `\— \dashClass % em
\XeTeXcharclass `\– \dashClass % en
\XeTeXcharclass `\- \dashClass % hyphen

\XeTeXinterchartokenstate = 1

\def\morhyphenpenalty{75}
\exhyphenpenalty=10000

\XeTeXinterchartoks \dashClass 0 = {\hskip 0pt\penalty \morhyphenpenalty}

%
% Adjust space around lists
%
\setlength{\topsep}{.5\baselineskip plus 1\baselineskip minus .5\baselineskip}
\setlength{\partopsep}{.5\baselineskip plus 1\baselineskip minus .5\baselineskip}

\usepackage[normalem]{ulem}
\usepackage{xfrac}
\usepackage{censor}
\usepackage[useregional]{datetime2}
